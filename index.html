<script>
    // ------------------------------
    // Tab 切換功能（保留原本）
    // ------------------------------
    function switchTab(tab) {
        // Hide all pages
        document.getElementById('itinerary-page').classList.add('hidden');
        document.getElementById('budget-page').classList.add('hidden');

        // Show target page
        if (tab === 'itinerary') {
            document.getElementById('itinerary-page').classList.remove('hidden');
        } else if (tab === 'budget') {
            document.getElementById('budget-page').classList.remove('hidden');
        } else {
            // For 'food' and 'tools', show itinerary as placeholder
            document.getElementById('itinerary-page').classList.remove('hidden');
        }

        // Update Nav Icons
        document.querySelectorAll('nav button').forEach(btn => {
            btn.classList.remove('active-tab');
            btn.classList.add('text-gray-300');
        });
        document.getElementById('nav-' + tab).classList.add('active-tab');
        document.getElementById('nav-' + tab).classList.remove('text-gray-300');

        console.log('Switch to ' + tab);
    }

    // ------------------------------
    // Day pill 選擇效果
    // ------------------------------
    document.querySelectorAll('.day-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active', 'bg-white', 'text-gray-400', 'border'));
            this.classList.add('active');
        });
    });

    // ------------------------------
    // 資料初始化
    // ------------------------------
    let trips = JSON.parse(localStorage.getItem('trips')) || [
        {time:'09:00', title:'清水寺參拜', note:'注意人潮，預計停留 2 小時', type:''},
        {time:'12:30', title:'奧丹豆腐料理', note:'已預約，位於二年坂附近', type:'美食'},
        {time:'15:00', title:'三年坂散策', note:'買特色御守、吃焙茶冰淇淋', type:''}
    ];

    let expenses = JSON.parse(localStorage.getItem('expenses')) || [
        {name:'食物', amount:5600},
        {name:'交通', amount:2490},
        {name:'景點', amount:4360}
    ];

    // ------------------------------
    // 行程管理
    // ------------------------------
    function renderTrips() {
        const container = document.querySelector('#itinerary-page .space-y-4');
        container.innerHTML = '';
        trips.forEach((trip, index) => {
            const li = document.createElement('div');
            li.className = 'morandi-card p-5 flex gap-4 items-start border-l-4 ' + (trip.type ? 'border-l-[#8E9775]' : 'border-l-transparent');
            li.innerHTML = `
                <span class="text-[11px] font-light text-gray-400 mt-1">${trip.time}</span>
                <div class="flex-1">
                    <h4 class="text-sm font-medium mb-1">${trip.title}</h4>
                    <p class="text-xs text-gray-400 font-light">${trip.note}</p>
                </div>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-[#FAF9F6] text-[#8E9775]">${trip.type}</span>
                <button class="text-gray-300 ml-2">刪除</button>
            `;
            li.querySelector('button').onclick = () => deleteTrip(index);
            container.appendChild(li);
        });
    }

    function addTrip() {
        const title = prompt('行程名稱？');
        if (!title) return;
        const time = prompt('時間？(例如 09:00)');
        if (!time) return;
        const note = prompt('備註？(可空白)') || '';
        const type = prompt('類別？(可空白)') || '';
        trips.push({time, title, note, type});
        localStorage.setItem('trips', JSON.stringify(trips));
        renderTrips();
    }

    function deleteTrip(index) {
        if (confirm('確定刪除這個行程嗎？')) {
            trips.splice(index, 1);
            localStorage.setItem('trips', JSON.stringify(trips));
            renderTrips();
        }
    }

    document.querySelector('#itinerary-page button.text-[#8E9775]').onclick = addTrip;

    // ------------------------------
    // 記帳管理
    // ------------------------------
    function renderExpenses() {
        const container = document.querySelector('#budget-page .space-y-4') || document.createElement('div');
        container.innerHTML = '';
        expenses.forEach((exp, index) => {
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="flex justify-between text-xs mb-2">
                    <span class="font-light">${exp.name}</span>
                    <span class="text-gray-400">¥ ${exp.amount}</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:0;"></div></div>
                <button class="text-xs mt-1 text-gray-500">刪除</button>
            `;
            div.querySelector('button').onclick = () => deleteExpense(index);
            container.appendChild(div);
        });
        const total = expenses.reduce((sum,e)=>sum+Number(e.amount),0);
        document.querySelector('#budget-page h2').textContent = `¥ ${total}`;
        document.querySelector('#budget-page p.text-[11px]').textContent = `≈ NT$ ${Math.round(total/4.65)}`;
        // 更新進度條百分比
        container.querySelectorAll('.progress-fill').forEach((bar,i)=>{
            const percent = total ? (expenses[i].amount/total*100) : 0;
            bar.style.width = percent + '%';
        });
        if (!document.querySelector('#budget-page .space-y-4')) document.querySelector('#budget-page').appendChild(container);
    }

    function addExpense() {
        const name = prompt('項目名稱？');
        if (!name) return;
        const amount = parseFloat(prompt('金額？'));
        if (isNaN(amount)) return alert('請輸入正確數字');
        expenses.push({name, amount});
        localStorage.setItem('expenses', JSON.stringify(expenses));
        renderExpenses();
    }

    function deleteExpense(index) {
        if (confirm('確定刪除這筆花費嗎？')) {
            expenses.splice(index, 1);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpenses();
        }
    }

    document.querySelector('#budget-page button').onclick = addExpense;

    // ------------------------------
    // 初始化渲染
    // ------------------------------
    renderTrips();
    renderExpenses();
</script>
